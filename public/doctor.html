    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SISGE-SALUD - Doctor</title>
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    </head>
    <body>
        <!-- Sidebar -->
        <nav class="sidebar-nav">
    <a href="#dashboard" class="nav-item active" id="navDashboard">
        <i class="fas fa-home"></i> Inicio
    </a>
    <a href="#perfil" class="nav-item" id="navPerfil">
        <i class="fas fa-user"></i> Mi Perfil
    </a>
    <a href="#agenda" class="nav-item" id="navAgenda">
        <i class="fas fa-calendar-alt"></i> Agenda Hoy
    </a>
    <a href="#atender" class="nav-item" id="navAtender">
        <i class="fas fa-stethoscope"></i> Atender Paciente
    </a>
    <a href="#recetar" class="nav-item" id="navRecetar">
        <i class="fas fa-prescription-bottle-alt"></i> Recetar
    </a>
    <a href="#examenes" class="nav-item" id="navExamenes">
        <i class="fas fa-file-medical"></i> √ìrdenes Ex√°menes
    </a>
    <a href="#" class="nav-item logout" id="navLogout">
        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
    </a>
</nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <div class="header-title">
                    <h1 id="pageTitle">Dashboard Doctor</h1>
                    <p id="pageSubtitle">Panel de control m√©dico</p>
                </div>
                <div class="header-actions">
                    <div class="time-display" id="currentTime">
                        <i class="fas fa-clock"></i> 
                        <span>Cargando...</span>
                    </div>
                    <div class="notifications">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="notificationCount">0</span>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area" id="contentArea">
                <!-- Dashboard ser√° cargado aqu√≠ por defecto -->
                <div class="loading-section">
                    <i class="fas fa-spinner fa-spin"></i> Cargando informaci√≥n...
                </div>
            </div>
        </main>

        <!-- Modal para atender paciente -->
        <div class="modal" id="attendPatientModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Atender Paciente</h3>
                    <button class="close-modal" onclick="closeAttendModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="attendPatientForm">
                        <input type="hidden" id="attendCitaId">
                        
                        <div class="patient-info-section">
                            <h4><i class="fas fa-user-injured"></i> Informaci√≥n del Paciente</h4>
                            <div class="patient-details" id="patientDetails">
                                <!-- Informaci√≥n se cargar√° aqu√≠ -->
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="attendType">
                                <i class="fas fa-clipboard-list"></i> Tipo de Atenci√≥n
                            </label>
                            <select id="attendType" required>
                                <option value="">Seleccionar tipo...</option>
                                <option value="Consulta General">Consulta General</option>
                                <option value="Control">Control</option>
                                <option value="Urgencia">Urgencia</option>
                                <option value="Seguimiento">Seguimiento</option>
                                <option value="Revisi√≥n">Revisi√≥n</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="diagnostico">
                                <i class="fas fa-file-medical-alt"></i> Diagn√≥stico
                            </label>
                            <textarea id="diagnostico" rows="4" required placeholder="Ingrese el diagn√≥stico del paciente..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="observaciones">
                                <i class="fas fa-comment-medical"></i> Observaciones
                            </label>
                            <textarea id="observaciones" rows="3" placeholder="Observaciones adicionales..."></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Atenci√≥n
                            </button>
                            <button type="button" class="btn btn-outline" onclick="closeAttendModal()">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para recetar -->
        <div class="modal" id="prescriptionModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>Crear Receta M√©dica</h3>
                    <button class="close-modal" onclick="closePrescriptionModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="prescriptionForm">
                        <input type="hidden" id="prescriptionAtencionId">
                        
                        <div class="form-group">
                            <label for="selectMedicamento">
                                <i class="fas fa-pills"></i> Medicamento
                            </label>
                            <select id="selectMedicamento" onchange="addMedicamentoToList()">
                                <option value="">Seleccionar medicamento...</option>
                            </select>
                        </div>
                        
                        <div class="medicamentos-list" id="medicamentosList">
                            <!-- Medicamentos a√±adidos aparecer√°n aqu√≠ -->
                            <div class="empty-state-small">
                                <i class="fas fa-prescription-bottle-alt"></i>
                                <p>No hay medicamentos a√±adidos</p>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-file-prescription"></i> Generar Receta
                            </button>
                            <button type="button" class="btn btn-outline" onclick="closePrescriptionModal()">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para crear examen -->
        <div class="modal" id="examModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Crear Orden de Examen</h3>
                    <button class="close-modal" onclick="closeExamModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="examForm">
                        <input type="hidden" id="examPacienteId">
                        
                        <div class="form-group">
                            <label for="examType">
                                <i class="fas fa-vial"></i> Tipo de Examen
                            </label>
                            <input type="text" id="examType" required placeholder="Ej: Hemograma completo, Rayos X t√≥rax...">
                        </div>
                        
                        <div class="form-group">
                            <label for="examObservations">
                                <i class="fas fa-clipboard"></i> Observaciones
                            </label>
                            <textarea id="examObservations" rows="3" placeholder="Instrucciones especiales para el examen..."></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Crear Orden
                            </button>
                            <button type="button" class="btn btn-outline" onclick="closeExamModal()">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
            // Token y usuario
            let token = localStorage.getItem('token');
            let user = JSON.parse(localStorage.getItem('user') || '{}');
            let currentDoctorId = null;
            
            // Verificar autenticaci√≥n
            if(!token || user.rol !== 'Doctor') {
                window.location.href = '/login.html';
            }
            
            // Actualizar hora actual
            function updateCurrentTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                const dateString = now.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const timeElement = document.getElementById('currentTime');
                if(timeElement) {
                    timeElement.innerHTML = `<i class="fas fa-clock"></i> ${timeString} - ${dateString}`;
                }
            }
            
            // Cargar datos iniciales
            document.addEventListener('DOMContentLoaded', async () => {
                // Actualizar hora cada minuto
                updateCurrentTime();
                setInterval(updateCurrentTime, 60000);
                
                // Verificar token
                try {
                    const response = await fetch('/api/verify-token', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if(!response.ok) {
                        throw new Error('Token inv√°lido');
                    }
                    
                    // Cargar perfil del doctor
                    await loadDoctorProfile();
                    
                    // Cargar dashboard por defecto
                    loadSection('dashboard',null);
                    
                } catch (error) {
                    logout();
                }
            });
            
            // Cargar perfil del doctor
            // Cargar perfil del doctor - CORREGIDA
async function loadDoctorProfile() {
    try {
        const response = await fetch('/api/perfil', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const data = await response.json();
        
        if(data.success) {
            const perfil = data.perfil;
            const detalles = perfil.detalles || {};
            
            // Mostrar informaci√≥n del doctor - VERIFICAR QUE LOS ELEMENTOS EXISTAN
            const userNameEl = document.getElementById('userName');
            const doctorSpecialtyEl = document.getElementById('doctorSpecialty');
            
            if (userNameEl) {
                userNameEl.textContent = perfil.nombre || 'Doctor';
            }
            
            if (doctorSpecialtyEl && detalles.especialidad) {
                doctorSpecialtyEl.textContent = detalles.especialidad;
            }
            
            // Guardar ID del doctor si existe
            if (detalles.id_doctor) {
                currentDoctorId = detalles.id_doctor;
            }
        }
        
    } catch (error) {
        console.error('Error cargando perfil del doctor:', error);
        // No mostrar error al usuario, solo log
    }
}
            
            // Funciones para cargar secciones
            // FUNCI√ìN PRINCIPAL PARA CARGAR SECCIONES - CORREGIDA
// FUNCI√ìN PRINCIPAL PARA CARGAR SECCIONES - CORREGIDA
async function loadSection(section, event = null) {
    console.log(`üü¢ Cargando secci√≥n doctor: ${section}`, event);
    
    const contentArea = document.getElementById('contentArea');
    if (!contentArea) {
        console.error('‚ùå No se encontr√≥ contentArea');
        return;
    }
    
    // Actualizar navegaci√≥n activa - FORMA SEGURA
    updateActiveNav(section, event);
    
    // Mostrar loading
    contentArea.innerHTML = `
        <div class="loading-section">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando ${section}...</p>
        </div>
    `;
    
    try {
        // Cargar la secci√≥n espec√≠fica
        switch(section) {
            case 'dashboard':
                await loadDashboard();
                break;
            case 'perfil':
                await loadPerfil();
                break;
            case 'agenda':
                await loadAgenda();
                break;
            case 'atender':
                await loadAtender();
                break;
            case 'recetar':
                await loadRecetar();
                break;
            case 'examenes':
                await loadExamenes();
                break;
            default:
                await loadDashboard();
        }
        
    } catch (error) {
        console.error(`‚ùå Error cargando ${section} doctor:`, error);
        showError(`Error al cargar ${section}. Intenta nuevamente.`);
    }
}

// FUNCI√ìN PARA ACTUALIZAR NAVEGACI√ìN ACTIVA - NUEVA
function updateActiveNav(section, event) {
    // Remover active de todos
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Agregar active al correspondiente
    let activeElement;
    
    if (event && event.target) {
        activeElement = event.target.closest('.nav-item');
    }
    
    if (!activeElement) {
        // Buscar por ID
        const sectionMap = {
            'dashboard': 'navDashboard',
            'perfil': 'navPerfil', 
            'agenda': 'navAgenda',
            'atender': 'navAtender',
            'recetar': 'navRecetar',
            'examenes': 'navExamenes'
        };
        
        const elementId = sectionMap[section];
        if (elementId) {
            activeElement = document.getElementById(elementId);
        }
    }
    
    if (activeElement) {
        activeElement.classList.add('active');
    }
}
            
            async function loadDashboard() {
                try {
                    const response = await fetch('/api/perfil', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if(data.success) {
                        const perfil = data.perfil;
                        const detalles = perfil.detalles || {};
                        
                        // Actualizar t√≠tulo
                        document.getElementById('pageTitle').textContent = 'Dashboard Doctor';
                        document.getElementById('pageSubtitle').textContent = `Bienvenido, Dr. ${perfil.nombre}`;
                        
                        // Mostrar dashboard
                        const contentArea = document.getElementById('contentArea');
                        contentArea.innerHTML = `
                            <div class="dashboard">
                                <div class="dashboard-header">
                                    <h2>Resumen M√©dico</h2>
                                    <p>Panel de control para gesti√≥n m√©dica</p>
                                </div>
                                
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-calendar-day"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3 id="citasHoy">${detalles.citas_hoy || 0}</h3>
                                            <p>Citas Hoy</p>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3 id="citasPendientes">${detalles.citas_pendientes || 0}</h3>
                                            <p>Citas Pendientes</p>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-user-injured"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3 id="pacientesAtendidos">...</h3>
                                            <p>Pacientes Hoy</p>
                                        </div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-prescription"></i>
                                        </div>
                                        <div class="stat-info">
                                            <h3 id="recetasHoy">0</h3>
                                            <p>Recetas Hoy</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="dashboard-sections">
                                    <div class="section-card">
                                        <h3><i class="fas fa-calendar-check"></i> Pr√≥ximas Citas</h3>
                                        <div id="nextAppointments" class="loading-item">
                                            <i class="fas fa-spinner fa-spin"></i> Cargando...
                                        </div>
                                    </div>
                                    
                                    <div class="section-card">
                                        <h3><i class="fas fa-bolt"></i> Acciones R√°pidas</h3>
                                        <div class="quick-actions">
                                            <button class="btn btn-primary" onclick="loadSection('agenda')">
                                                <i class="fas fa-calendar-alt"></i> Ver Agenda
                                            </button>
                                            <button class="btn btn-secondary" onclick="loadSection('atender')">
                                                <i class="fas fa-stethoscope"></i> Atender Paciente
                                            </button>
                                            <button class="btn btn-outline" onclick="loadSection('recetar')">
                                                <i class="fas fa-prescription-bottle-alt"></i> Crear Receta
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="section-card full-width">
                                    <h3><i class="fas fa-chart-line"></i> Actividad Reciente</h3>
                                    <div id="recentActivity" class="loading-item">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando actividad...
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Cargar datos adicionales
                        loadDashboardData();
                    }
                    
                } catch (error) {
                    console.error('Error cargando dashboard:', error);
                    showError('Error al cargar el dashboard');
                }
            }
            
            async function loadDashboardData() {
    try {
        // Cargar citas de hoy
        const citasRes = await fetch('/api/doctor/agenda', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const citasData = await citasRes.json();
        
        if(citasData.success) {
            // Actualizar citas de hoy - VERIFICAR QUE EL ELEMENTO EXISTA
            const citasHoyElement = document.getElementById('citasHoy');
            if (citasHoyElement) {
                citasHoyElement.textContent = citasData.total || 0;
            }
            
            // Mostrar pr√≥ximas citas - VERIFICAR QUE EL ELEMENTO EXISTA
            const nextAppointments = document.getElementById('nextAppointments');
            if (nextAppointments) {
                if(citasData.agenda && citasData.agenda.length > 0) {
                    const ahora = new Date();
                    const citasFuturas = citasData.agenda.filter(cita => {
                        const fechaCita = new Date(cita.fecha_hora);
                        return fechaCita > ahora && cita.estado === 'Pendiente';
                    }).slice(0, 3);
                    
                    if(citasFuturas.length > 0) {
                        nextAppointments.innerHTML = citasFuturas.map(cita => `
                            <div class="appointment-item">
                                <div class="appointment-time">
                                    <strong>${new Date(cita.fecha_hora).toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</strong>
                                </div>
                                <div class="appointment-details">
                                    <strong>${cita.paciente_nombre}</strong>
                                    <small>DNI: ${cita.paciente_dni}</small>
                                </div>
                                <div class="appointment-actions">
                                    <button class="btn-icon" onclick="atenderPaciente('${cita.id_cita}')" title="Atender">
                                        <i class="fas fa-play"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        nextAppointments.innerHTML = `
                            <div class="no-data">
                                <p>No hay citas pendientes para hoy</p>
                            </div>
                        `;
                    }
                } else {
                    nextAppointments.innerHTML = `
                        <div class="no-data">
                            <p>No hay citas programadas para hoy</p>
                        </div>
                    `;
                }
            }
        }
        
    } catch (error) {
        console.error('Error cargando datos del dashboard:', error);
        // No mostrar error al usuario, solo log
    }
}
            
            async function loadPerfil() {
                try {
                    const response = await fetch('/api/perfil', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if(data.success) {
                        const perfil = data.perfil;
                        const detalles = perfil.detalles || {};
                        
                        // Actualizar t√≠tulo
                        document.getElementById('pageTitle').textContent = 'Mi Perfil';
                        document.getElementById('pageSubtitle').textContent = 'Informaci√≥n profesional';
                        
                        // Mostrar perfil
                        const contentArea = document.getElementById('contentArea');
                        contentArea.innerHTML = `
                            <div class="profile-section">
                                <div class="profile-header">
                                    <div class="profile-avatar">
                                        <i class="fas fa-user-md"></i>
                                    </div>
                                    <div class="profile-info">
                                        <h2>Dr. ${detalles.nombres || ''} ${detalles.apellidos || ''}</h2>
                                        <p><i class="fas fa-user-tag"></i> ${detalles.especialidad || 'M√©dico'}</p>
                                        <p><i class="fas fa-envelope"></i> ${user.email}</p>
                                    </div>
                                </div>
                                
                                <div class="profile-details">
                                    <div class="detail-card">
                                        <h3><i class="fas fa-id-card"></i> Informaci√≥n Profesional</h3>
                                        <div class="detail-grid">
                                            <div class="detail-item">
                                                <label>DNI:</label>
                                                <span>${detalles.dni || 'No registrado'}</span>
                                            </div>
                                            <div class="detail-item">
                                                <label>Especialidad:</label>
                                                <span>${detalles.especialidad || 'No registrada'}</span>
                                            </div>
                                            <div class="detail-item">
                                                <label>C√≥digo M√©dico:</label>
                                                <span>${detalles.codigo_medico || 'No registrado'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="detail-card">
                                        <h3><i class="fas fa-chart-bar"></i> Estad√≠sticas</h3>
                                        <div class="detail-grid">
                                            <div class="detail-item">
                                                <label>Citas Hoy:</label>
                                                <span>${detalles.citas_hoy || 0}</span>
                                            </div>
                                            <div class="detail-item">
                                                <label>Citas Pendientes:</label>
                                                <span>${detalles.citas_pendientes || 0}</span>
                                            </div>
                                            <div class="detail-item">
                                                <label>Pacientes Atendidos:</label>
                                                <span>${detalles.pacientes_atendidos || 0}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="profile-actions">
                                    <button class="btn btn-outline" onclick="editarPerfilDoctor()">
                                        <i class="fas fa-edit"></i> Editar Perfil
                                    </button>
                                    <button class="btn btn-outline" onclick="verHorario()">
                                        <i class="fas fa-clock"></i> Ver Horario
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('Error cargando perfil:', error);
                    showError('Error al cargar el perfil');
                }
            }
            
            async function loadAgenda() {
                try {
                    const response = await fetch('/api/doctor/citas/hoy', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    // Actualizar t√≠tulo
                    document.getElementById('pageTitle').textContent = 'Agenda del D√≠a';
                    document.getElementById('pageSubtitle').textContent = 'Citas programadas para hoy';
                    
                    const contentArea = document.getElementById('contentArea');
                    
                    if(data.success && data.citas && data.citas.length > 0) {
                        // Ordenar citas por hora
                        const citasOrdenadas = data.citas.sort((a, b) => 
                            new Date(a.fecha_hora) - new Date(b.fecha_hora)
                        );
                        
                        contentArea.innerHTML = `
                            <div class="agenda-section">
                                <div class="section-header">
                                    <h2>Mi Agenda M√©dica</h2>
                                    <div class="agenda-stats">
                                        <span class="stat-badge">
                                            <i class="fas fa-calendar-check"></i>
                                            Total: ${citasOrdenadas.length}
                                        </span>
                                        <span class="stat-badge">
                                            <i class="fas fa-clock"></i>
                                            Pendientes: ${citasOrdenadas.filter(c => c.estado === 'Pendiente').length}
                                        </span>
                                        <span class="stat-badge">
                                            <i class="fas fa-check-circle"></i>
                                            Atendidas: ${citasOrdenadas.filter(c => c.estado === 'Completada').length}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="agenda-timeline">
                                    ${citasOrdenadas.map(cita => `
                                        <div class="agenda-item ${cita.estado.toLowerCase()}">
                                            <div class="agenda-time">
                                                <strong>${new Date(cita.fecha_hora).toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</strong>
                                            </div>
                                            <div class="agenda-content">
                                                <div class="agenda-header">
                                                    <h3>${cita.paciente_nombre}</h3>
                                                    <span class="agenda-status ${cita.estado.toLowerCase()}">
                                                        ${cita.estado}
                                                    </span>
                                                </div>
                                                <div class="agenda-details">
                                                    <p><i class="fas fa-id-card"></i> DNI: ${cita.paciente_dni}</p>
                                                    <p><i class="fas fa-hospital"></i> ${cita.hospital_nombre || 'Sin hospital asignado'}</p>
                                                </div>
                                                <div class="agenda-actions">
                                                    ${cita.estado === 'Pendiente' ? `
                                                        <button class="btn btn-primary btn-small" onclick="atenderPaciente('${cita.id_cita}')">
                                                            <i class="fas fa-play"></i> Atender
                                                        </button>
                                                    ` : ''}
                                                    <button class="btn btn-outline btn-small" onclick="verHistorialPaciente('${cita.id_paciente}')">
                                                        <i class="fas fa-history"></i> Historial
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                ${citasOrdenadas.length === 0 ? `
                                    <div class="empty-state">
                                        <i class="fas fa-calendar-times"></i>
                                        <h3>No hay citas programadas para hoy</h3>
                                        <p>Tu agenda est√° libre para el d√≠a de hoy</p>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        contentArea.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-calendar-times"></i>
                                <h3>No hay citas programadas para hoy</h3>
                                <p>Tu agenda est√° libre para el d√≠a de hoy</p>
                                <div class="quick-actions">
                                    <button class="btn btn-outline" onclick="loadSection('dashboard')">
                                        <i class="fas fa-home"></i> Volver al Dashboard
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('Error cargando agenda:', error);
                    showError('Error al cargar la agenda');
                }
            }
            
            async function loadAtender() {
                // Actualizar t√≠tulo
                document.getElementById('pageTitle').textContent = 'Atender Paciente';
                document.getElementById('pageSubtitle').textContent = 'Registrar atenci√≥n m√©dica';
                
                const contentArea = document.getElementById('contentArea');
                contentArea.innerHTML = `
                    <div class="atender-section">
                        <div class="section-header">
                            <h2>Atender Paciente</h2>
                            <p>Selecciona una cita para comenzar la atenci√≥n</p>
                        </div>
                        
                        <div class="atender-instructions">
                            <div class="instruction-card">
                                <i class="fas fa-1"></i>
                                <h4>Selecciona una cita pendiente</h4>
                                <p>Elige un paciente de tu lista de citas del d√≠a</p>
                            </div>
                            <div class="instruction-card">
                                <i class="fas fa-2"></i>
                                <h4>Registra el diagn√≥stico</h4>
                                <p>Ingresa los detalles de la consulta y diagn√≥stico</p>
                            </div>
                            <div class="instruction-card">
                                <i class="fas fa-3"></i>
                                <h4>Genera receta si es necesario</h4>
                                <p>Crea recetas m√©dicas digitales para el paciente</p>
                            </div>
                        </div>
                        
                        <div class="citas-pendientes-section">
                            <h3><i class="fas fa-clock"></i> Citas Pendientes de Hoy</h3>
                            <div id="pendingAppointments" class="loading-item">
                                <i class="fas fa-spinner fa-spin"></i> Cargando citas pendientes...
                            </div>
                        </div>
                    </div>
                `;
                
                // Cargar citas pendientes
                await loadCitasPendientes();
            }
            
            async function loadCitasPendientes() {
                try {
                    const response = await fetch('/api/doctor/citas/hoy', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    const pendingContainer = document.getElementById('pendingAppointments');
                    
                    if(data.success && data.citas && data.citas.length > 0) {
                        const citasPendientes = data.citas.filter(cita => cita.estado === 'Pendiente');
                        
                        if(citasPendientes.length > 0) {
                            pendingContainer.innerHTML = `
                                <div class="citas-grid">
                                    ${citasPendientes.map(cita => `
                                        <div class="cita-card">
                                            <div class="cita-header">
                                                <h4>${cita.paciente_nombre}</h4>
                                                <span class="cita-time">
                                                    ${new Date(cita.fecha_hora).toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}
                                                </span>
                                            </div>
                                            <div class="cita-details">
                                                <p><i class="fas fa-id-card"></i> ${cita.paciente_dni}</p>
                                                <p><i class="fas fa-hospital"></i> ${cita.hospital_nombre || 'No especificado'}</p>
                                            </div>
                                            <div class="cita-actions">
                                                <button class="btn btn-primary" onclick="atenderPaciente('${cita.id_cita}')">
                                                    <i class="fas fa-play"></i> Comenzar Atenci√≥n
                                                </button>
                                                <button class="btn btn-outline" onclick="verHistorialPaciente('${cita.id_paciente}')">
                                                    <i class="fas fa-history"></i> Historial
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        } else {
                            pendingContainer.innerHTML = `
                                <div class="empty-state-small">
                                    <i class="fas fa-calendar-check"></i>
                                    <p>No hay citas pendientes para hoy</p>
                                    <small>Todas las citas han sido atendidas</small>
                                </div>
                            `;
                        }
                    } else {
                        pendingContainer.innerHTML = `
                            <div class="empty-state-small">
                                <i class="fas fa-calendar-times"></i>
                                <p>No hay citas programadas para hoy</p>
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('Error cargando citas pendientes:', error);
                    pendingContainer.innerHTML = `
                        <div class="error-state-small">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Error al cargar las citas</p>
                        </div>
                    `;
                }
            }
            
            async function atenderPaciente(citaId) {
    try {
        // Obtener informaci√≥n completa de la cita
        const response = await fetch(`/api/citas/${citaId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const cita = data.cita;
            
            // Abrir modal de atenci√≥n con datos reales
            openAttendModal(citaId, {
                paciente_nombre: cita.paciente_nombre || 'Paciente',
                paciente_dni: cita.paciente_dni || 'N/A',
                fecha_hora: cita.fecha_hora,
                especialidad: cita.especialidad || 'General',
                hospital_nombre: cita.hospital_nombre || 'N/A'
            });
        } else {
            showNotification('Error al obtener informaci√≥n de la cita', 'error');
        }
        
    } catch (error) {
        console.error('Error preparando atenci√≥n:', error);
        showNotification('Error al preparar la atenci√≥n', 'error');
    }
}
            
            function openAttendModal(citaId, citaInfo) {
                const modal = document.getElementById('attendPatientModal');
                modal.style.display = 'flex';
                
                // Configurar ID de la cita
                document.getElementById('attendCitaId').value = citaId;
                
                // Mostrar informaci√≥n del paciente
                const patientDetails = document.getElementById('patientDetails');
                patientDetails.innerHTML = `
                    <div class="patient-detail-item">
                        <label>Paciente:</label>
                        <span>${citaInfo.paciente_nombre}</span>
                    </div>
                    <div class="patient-detail-item">
                        <label>DNI:</label>
                        <span>${citaInfo.paciente_dni}</span>
                    </div>
                    <div class="patient-detail-item">
                        <label>Hora de cita:</label>
                        <span>${new Date(citaInfo.fecha_hora).toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                `;
            }
            
            function closeAttendModal() {
                const modal = document.getElementById('attendPatientModal');
                modal.style.display = 'none';
                document.getElementById('attendPatientForm').reset();
            }
            
            // Manejar atenci√≥n del paciente - VERSI√ìN CORREGIDA
document.getElementById('attendPatientForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const citaId = document.getElementById('attendCitaId').value;
    const tipoAtencion = document.getElementById('attendType').value;
    const diagnostico = document.getElementById('diagnostico').value;
    const observaciones = document.getElementById('observaciones').value;
    
    if(!tipoAtencion || !diagnostico) {
        showNotification('Por favor complete todos los campos requeridos', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/doctor/atender', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                id_cita: citaId,
                tipo_atencion: tipoAtencion,
                diagnostico: diagnostico,
                observaciones: observaciones
            })
        });
        
        const data = await response.json();
        
        if(data.success) {
            showNotification('¬°Atenci√≥n registrada exitosamente!', 'success');
            closeAttendModal();
            
            // Preguntar si desea crear receta
            if(confirm('¬øDesea crear una receta para este paciente?')) {
                openPrescriptionModal(data.id_atencion);
            }
            
            // Recargar secciones
            loadAgenda();
            loadDashboard();
            
        } else {
            showNotification(data.message || 'Error al registrar la atenci√≥n', 'error');
        }
        
    } catch (error) {
        console.error('Error registrando atenci√≥n:', error);
        showNotification('Error de conexi√≥n al registrar la atenci√≥n', 'error');
    }
});
            
            // Funciones para recetas
            async function loadRecetar() {
                // Actualizar t√≠tulo
                document.getElementById('pageTitle').textContent = 'Crear Recetas';
                document.getElementById('pageSubtitle').textContent = 'Generar recetas m√©dicas digitales';
                
                const contentArea = document.getElementById('contentArea');
                contentArea.innerHTML = `
                    <div class="recetar-section">
                        <div class="section-header">
                            <h2>Gesti√≥n de Recetas</h2>
                            <p>Crea y gestiona recetas m√©dicas para tus pacientes</p>
                        </div>
                        
                        <div class="recetar-actions">
                            <div class="action-card" onclick="crearRecetaNueva()">
                                <div class="action-icon">
                                    <i class="fas fa-file-prescription"></i>
                                </div>
                                <h3>Crear Nueva Receta</h3>
                                <p>Genera una receta m√©dica desde cero</p>
                            </div>
                            
                            <div class="action-card" onclick="verRecetasRecientes()">
                                <div class="action-icon">
                                    <i class="fas fa-history"></i>
                                </div>
                                <h3>Ver Historial</h3>
                                <p>Consulta recetas creadas anteriormente</p>
                            </div>
                            
                            <div class="action-card" onclick="cargarPlantillas()">
                                <div class="action-icon">
                                    <i class="fas fa-copy"></i>
                                </div>
                                <h3>Plantillas</h3>
                                <p>Usa plantillas predefinidas</p>
                            </div>
                        </div>
                        
                        <div class="recetar-guia">
                            <h3><i class="fas fa-info-circle"></i> ¬øC√≥mo crear una receta?</h3>
                            <ol>
                                <li>Completa una atenci√≥n m√©dica para un paciente</li>
                                <li>Selecciona los medicamentos necesarios</li>
                                <li>Especifica las dosis e indicaciones</li>
                                <li>Genera la receta digital</li>
                                <li>El paciente podr√° acceder a su receta desde su perfil</li>
                            </ol>
                        </div>
                    </div>
                `;
            }
            
            function crearRecetaNueva() {
                // En una implementaci√≥n real, aqu√≠ se cargar√≠an las atenciones recientes
                // Por ahora abrimos modal de receta vac√≠o
                openPrescriptionModal();
            }
            
            async function openPrescriptionModal(atencionId = null) {
                const modal = document.getElementById('prescriptionModal');
                modal.style.display = 'flex';
                
                if(atencionId) {
                    document.getElementById('prescriptionAtencionId').value = atencionId;
                }
                
                // Cargar medicamentos
                try {
                    const response = await fetch('/api/medicamentos');
                    const data = await response.json();
                    
                    const select = document.getElementById('selectMedicamento');
                    select.innerHTML = '<option value="">Seleccionar medicamento...</option>';
                    
                    if(data.success && data.medicamentos) {
                        data.medicamentos.forEach(med => {
                            const option = document.createElement('option');
                            option.value = med.id_medicamento;
                            option.textContent = `${med.nombre} - ${med.presentacion}`;
                            option.dataset.nombre = med.nombre;
                            option.dataset.presentacion = med.presentacion;
                            select.appendChild(option);
                        });
                    }
                    
                } catch (error) {
                    console.error('Error cargando medicamentos:', error);
                }
            }
            
            function closePrescriptionModal() {
                const modal = document.getElementById('prescriptionModal');
                modal.style.display = 'none';
                document.getElementById('prescriptionForm').reset();
                document.getElementById('medicamentosList').innerHTML = `
                    <div class="empty-state-small">
                        <i class="fas fa-prescription-bottle-alt"></i>
                        <p>No hay medicamentos a√±adidos</p>
                    </div>
                `;
            }
            
            function addMedicamentoToList() {
                const select = document.getElementById('selectMedicamento');
                const selectedOption = select.options[select.selectedIndex];
                
                if(!selectedOption.value) return;
                
                const medicamentosList = document.getElementById('medicamentosList');
                
                // Remover mensaje de vac√≠o si existe
                if(medicamentosList.querySelector('.empty-state-small')) {
                    medicamentosList.innerHTML = '';
                }
                
                // Crear elemento del medicamento
                const medicamentoDiv = document.createElement('div');
                medicamentoDiv.className = 'medicamento-item';
                medicamentoDiv.innerHTML = `
                    <div class="medicamento-info">
                        <h4>${selectedOption.dataset.nombre}</h4>
                        <small>${selectedOption.dataset.presentacion}</small>
                    </div>
                    <div class="medicamento-form">
                        <input type="text" class="indicaciones-input" placeholder="Indicaciones (ej: 1 tableta cada 8 horas)">
                        <button type="button" class="btn-icon" onclick="removeMedicamento(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                medicamentosList.appendChild(medicamentoDiv);
                
                // Limpiar selecci√≥n
                select.selectedIndex = 0;
            }
            
            function removeMedicamento(button) {
                const medicamentoItem = button.closest('.medicamento-item');
                medicamentoItem.remove();
                
                // Mostrar mensaje de vac√≠o si no hay medicamentos
                const medicamentosList = document.getElementById('medicamentosList');
                if(medicamentosList.children.length === 0) {
                    medicamentosList.innerHTML = `
                        <div class="empty-state-small">
                            <i class="fas fa-prescription-bottle-alt"></i>
                            <p>No hay medicamentos a√±adidos</p>
                        </div>
                    `;
                }
            }
            
            // Manejar creaci√≥n de receta
            // Manejar creaci√≥n de receta - VERSI√ìN CORREGIDA
document.getElementById('prescriptionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const atencionId = document.getElementById('prescriptionAtencionId').value;
    const medicamentosItems = document.querySelectorAll('.medicamento-item');
    
    if(medicamentosItems.length === 0) {
        showNotification('Debe agregar al menos un medicamento', 'error');
        return;
    }
    
    const medicamentos = [];
    medicamentosItems.forEach(item => {
        const medicamentoId = item.querySelector('.medicamento-id')?.value;
        const indicaciones = item.querySelector('.indicaciones-input')?.value;
        
        if(medicamentoId && indicaciones) {
            medicamentos.push({
                id_medicamento: parseInt(medicamentoId),
                indicaciones: indicaciones
            });
        }
    });
    
    try {
        const response = await fetch('/api/doctor/recetas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                id_atencion: atencionId,
                medicamentos: medicamentos
            })
        });
        
        const data = await response.json();
        
        if(data.success) {
            showNotification('Receta creada exitosamente', 'success');
            closePrescriptionModal();
            // Recargar datos si es necesario
        } else {
            showNotification(data.message || 'Error al crear la receta', 'error');
        }
        
    } catch (error) {
        console.error('Error creando receta:', error);
        showNotification('Error al crear la receta', 'error');
    }
});
            
            // Funciones para ex√°menes
            async function loadExamenes() {
                // Actualizar t√≠tulo
                document.getElementById('pageTitle').textContent = '√ìrdenes de Ex√°menes';
                document.getElementById('pageSubtitle').textContent = 'Gestionar √≥rdenes de ex√°menes m√©dicos';
                
                const contentArea = document.getElementById('contentArea');
                contentArea.innerHTML = `
                    <div class="examenes-section">
                        <div class="section-header">
                            <h2>Gesti√≥n de Ex√°menes</h2>
                            <button class="btn btn-primary" onclick="crearNuevoExamen()">
                                <i class="fas fa-plus"></i> Nueva Orden
                            </button>
                        </div>
                        
                        <div class="examenes-stats">
                            <div class="stat-card-small">
                                <i class="fas fa-clock"></i>
                                <div>
                                    <h3 id="examenesPendientes">0</h3>
                                    <p>Pendientes</p>
                                </div>
                            </div>
                            <div class="stat-card-small">
                                <i class="fas fa-check-circle"></i>
                                <div>
                                    <h3 id="examenesCompletados">0</h3>
                                    <p>Completados</p>
                                </div>
                            </div>
                            <div class="stat-card-small">
                                <i class="fas fa-vial"></i>
                                <div>
                                    <h3 id="examenesTotal">0</h3>
                                    <p>Total</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Paciente</th>
                                        <th>Tipo de Examen</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="examenesTable">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Cargando ex√°menes...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Cargar ex√°menes
                await loadExamenesData();
            }
            
            async function loadExamenesData() {
                try {
                    // En una implementaci√≥n real, aqu√≠ se cargar√≠an los ex√°menes del doctor
                    // Simulamos datos por ahora
                    
                    setTimeout(() => {
                        document.getElementById('examenesTable').innerHTML = `
                            <tr>
                                <td>Juan P√©rez</td>
                                <td>Hemograma completo</td>
                                <td>${new Date().toLocaleDateString('es-ES')}</td>
                                <td><span class="status pendiente">Pendiente</span></td>
                                <td>
                                    <button class="btn-icon" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-icon" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>Mar√≠a L√≥pez</td>
                                <td>Rayos X de t√≥rax</td>
                                <td>${new Date().toLocaleDateString('es-ES')}</td>
                                <td><span class="status completada">Completada</span></td>
                                <td>
                                    <button class="btn-icon" title="Ver resultados">
                                        <i class="fas fa-file-medical-alt"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        
                        // Actualizar estad√≠sticas
                        document.getElementById('examenesPendientes').textContent = '1';
                        document.getElementById('examenesCompletados').textContent = '1';
                        document.getElementById('examenesTotal').textContent = '2';
                        
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error cargando ex√°menes:', error);
                    document.getElementById('examenesTable').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center error">
                                Error al cargar los ex√°menes
                            </td>
                        </tr>
                    `;
                }
            }
            
            function crearNuevoExamen() {
                // Abrir modal para crear examen
                const modal = document.getElementById('examModal');
                modal.style.display = 'flex';
            }
            
            function closeExamModal() {
                const modal = document.getElementById('examModal');
                modal.style.display = 'none';
                document.getElementById('examForm').reset();
            }
            
            // Manejar creaci√≥n de examen
            document.getElementById('examForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const tipoExamen = document.getElementById('examType').value;
                const observaciones = document.getElementById('examObservations').value;
                const pacienteId = document.getElementById('examPacienteId').value;
                
                if(!tipoExamen) {
                    showNotification('Debe especificar el tipo de examen', 'error');
                    return;
                }
                
                try {
                    // En una implementaci√≥n real, aqu√≠ se enviar√≠a a la API
                    const response = await fetch('/api/examenes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            id_paciente: pacienteId || 'aaaa1111-aaaa-1111-aaaa-111111111111', // ID de ejemplo
                            tipo_examen: tipoExamen,
                            observaciones: observaciones
                        })
                    });
                    
                    const data = await response.json();
                    
                    if(data.success) {
                        showNotification('Orden de examen creada exitosamente', 'success');
                        closeExamModal();
                        loadExamenesData(); // Recargar lista
                    } else {
                        showNotification(data.message || 'Error al crear la orden', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error creando examen:', error);
                    showNotification('Error al crear la orden de examen', 'error');
                }
            });
            
            // Funciones auxiliares
            function showNotification(message, type = 'info') {
                // Crear notificaci√≥n
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()">&times;</button>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remover despu√©s de 5 segundos
                setTimeout(() => {
                    if(notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
            
            function showError(message) {
                const contentArea = document.getElementById('contentArea');
                contentArea.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error</h3>
                        <p>${message}</p>
                        <button class="btn btn-primary" onclick="loadSection('dashboard')">
                            <i class="fas fa-home"></i> Volver al Inicio
                        </button>
                    </div>
                `;
            }
            
            function logout() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            }
            
            // Funciones placeholder
            function verHistorialPaciente(pacienteId) {
                showNotification('Funcionalidad de historial en desarrollo', 'info');
            }
            
            function verRecetasRecientes() {
                showNotification('Funcionalidad de historial de recetas en desarrollo', 'info');
            }
            
            function cargarPlantillas() {
                showNotification('Funcionalidad de plantillas en desarrollo', 'info');
            }
            
            function editarPerfilDoctor() {
                showNotification('Funcionalidad de edici√≥n de perfil en desarrollo', 'info');
            }
            
            function verHorario() {
                showNotification('Funcionalidad de horario en desarrollo', 'info');
            }
            
            // Cerrar modales al hacer clic fuera
            window.onclick = function(event) {
                const modals = ['attendPatientModal', 'prescriptionModal', 'examModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if(event.target === modal) {
                        if(modalId === 'attendPatientModal') closeAttendModal();
                        else if(modalId === 'prescriptionModal') closePrescriptionModal();
                        else if(modalId === 'examModal') closeExamModal();
                    }
                });
            };
            // ============================================
// CONFIGURAR EVENT LISTENERS DESPU√âS DE DOMContentLoaded
// ============================================

function setupEventListeners() {
    console.log('üü¢ Configurando event listeners doctor...');
    
    // Navegaci√≥n del sidebar
    document.getElementById('navDashboard')?.addEventListener('click', function(e) {
        e.preventDefault();
        loadSection('dashboard', e);
    });
    
    document.getElementById('navPerfil')?.addEventListener('click', function(e) {
        e.preventDefault();
        loadSection('perfil', e);
    });
    
    document.getElementById('navAgenda')?.addEventListener('click', function(e) {
        e.preventDefault();
        loadSection('agenda', e);
    });
    
    document.getElementById('navAtender')?.addEventListener('click', function(e) {
        e.preventDefault();
        loadSection('atender', e);
    });
    
    document.getElementById('navRecetar')?.addEventListener('click', function(e) {
        e.preventDefault();
        loadSection('recetar', e);
    });
    
    document.getElementById('navExamenes')?.addEventListener('click', function(e) {
        e.preventDefault();
        loadSection('examenes', e);
    });
    
    document.getElementById('navLogout')?.addEventListener('click', function(e) {
        e.preventDefault();
        logout();
    });
    
    // Configurar botones dentro del dashboard (se configurar√°n despu√©s de cargar)
    setTimeout(() => {
        // Botones de acciones r√°pidas en dashboard
        const quickActionButtons = document.querySelectorAll('.quick-actions button');
        quickActionButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const text = this.textContent || this.innerText;
                if (text.includes('Ver Agenda')) {
                    loadSection('agenda', e);
                } else if (text.includes('Atender Paciente')) {
                    loadSection('atender', e);
                } else if (text.includes('Crear Receta')) {
                    loadSection('recetar', e);
                }
            });
        });
    }, 1000);
}

// ============================================
// MODIFICAR EL DOMContentLoaded
// ============================================

// En tu DOMContentLoaded (~l√≠nea 245), DESPU√âS de verificar el token, agrega:
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üü¢ Iniciando dashboard doctor...');
    
    // Actualizar hora cada minuto
    updateCurrentTime();
    setInterval(updateCurrentTime, 60000);
    
    // Verificar token
    try {
        const response = await fetch('/api/verify-token', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if(!response.ok) {
            throw new Error('Token inv√°lido');
        }
        
        const data = await response.json();  // ‚Üê 'data' definida aqu√≠
        console.log('‚úÖ Token doctor v√°lido:', data);
        
        // Configurar event listeners
        setupEventListeners();
        
        // Cargar dashboard por defecto
        loadSection('dashboard', null);
        
    } catch (error) {
        console.error('‚ùå Error de autenticaci√≥n doctor:', error);
        logout();
    }
});
        </script>
        
        <style>
            /* Estilos adicionales para doctor */
            .modal-large {
                max-width: 700px;
            }
            
            .agenda-timeline {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .agenda-item {
                background: white;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                display: flex;
                overflow: hidden;
                border-left: 4px solid var(--secondary-color);
            }
            
            .agenda-item.pendiente {
                border-left-color: var(--warning-color);
            }
            
            .agenda-item.completada {
                border-left-color: var(--success-color);
            }
            
            .agenda-time {
                background: var(--light-gray);
                padding: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 100px;
            }
            
            .agenda-content {
                flex: 1;
                padding: 20px;
            }
            
            .agenda-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
            
            .agenda-status {
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
            }
            
            .agenda-details {
                display: flex;
                gap: 20px;
                margin-bottom: 15px;
            }
            
            .agenda-details p {
                display: flex;
                align-items: center;
                gap: 5px;
                color: var(--gray-color);
            }
            
            .citas-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }
            
            .cita-card {
                background: white;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                padding: 20px;
                transition: var(--transition);
            }
            
            .cita-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            }
            
            .cita-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
            
            .cita-time {
                background: var(--light-color);
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }
            
            .patient-info-section {
                background: var(--light-gray);
                padding: 15px;
                border-radius: var(--radius);
                margin-bottom: 20px;
            }
            
            .patient-details {
                display: grid;
                gap: 10px;
                margin-top: 10px;
            }
            
            .patient-detail-item {
                display: flex;
                justify-content: space-between;
                padding-bottom: 8px;
                border-bottom: 1px solid #ddd;
            }
            
            .patient-detail-item:last-child {
                border-bottom: none;
            }
            
            .medicamentos-list {
                max-height: 300px;
                overflow-y: auto;
                margin: 20px 0;
                padding: 10px;
                background: var(--light-gray);
                border-radius: var(--radius);
            }
            
            .medicamento-item {
                background: white;
                padding: 15px;
                border-radius: var(--radius);
                margin-bottom: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .medicamento-item:last-child {
                margin-bottom: 0;
            }
            
            .medicamento-form {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            
            .indicaciones-input {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: var(--radius);
                min-width: 250px;
            }
            
            .agenda-stats {
                display: flex;
                gap: 15px;
            }
            
            .stat-badge {
                background: var(--light-gray);
                padding: 8px 15px;
                border-radius: 20px;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .action-card {
                background: white;
                padding: 30px;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                text-align: center;
                cursor: pointer;
                transition: var(--transition);
            }
            
            .action-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            }
            
            .action-icon {
                width: 70px;
                height: 70px;
                border-radius: 50%;
                background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 32px;
                margin: 0 auto 20px;
            }
            
            .recetar-actions {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin: 30px 0;
            }
            
            .recetar-guia {
                background: var(--light-gray);
                padding: 25px;
                border-radius: var(--radius);
                margin-top: 30px;
            }
            
            .recetar-guia ol {
                margin-left: 20px;
                margin-top: 15px;
            }
            
            .recetar-guia li {
                margin-bottom: 10px;
            }
            
            .appointment-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 12px;
                background: white;
                border-radius: var(--radius);
                margin-bottom: 10px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            .appointment-item:last-child {
                margin-bottom: 0;
            }
            
            .activity-list {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .activity-item {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 15px;
                background: white;
                border-radius: var(--radius);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            .activity-item i {
                color: var(--secondary-color);
                font-size: 20px;
            }
            
            .examenes-stats {
                display: flex;
                gap: 20px;
                margin: 20px 0;
            }
            
            .stat-card-small {
                flex: 1;
                background: white;
                padding: 20px;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                display: flex;
                align-items: center;
                gap: 15px;
            }
            
            .stat-card-small i {
                font-size: 32px;
                color: var(--secondary-color);
            }
            
            .atender-instructions {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin: 30px 0;
            }
            
            .instruction-card {
                background: white;
                padding: 25px;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                text-align: center;
            }
            
            .instruction-card i {
                font-size: 48px;
                color: var(--secondary-color);
                margin-bottom: 15px;
            }
            
            .citas-pendientes-section {
                margin-top: 40px;
            }
            
            .empty-state-small, .error-state-small {
                text-align: center;
                padding: 30px;
                background: white;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
            }
            
            .empty-state-small i, .error-state-small i {
                font-size: 48px;
                color: var(--gray-color);
                margin-bottom: 15px;
            }
            
            .error-state-small i {
                color: var(--danger-color);
            }
            
            .time-display {
                background: var(--light-gray);
                padding: 8px 15px;
                border-radius: 20px;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
            }
            
            .full-width {
                grid-column: 1 / -1;
            }
            
            .loading-item {
                padding: 30px;
                text-align: center;
                color: var(--gray-color);
            }
        </style>
    </body>
    </html>